# Perfex API Worker Configuration
name = "perfex-api"
main = "src/index.ts"
compatibility_date = "2024-11-24"
account_id = "6435a77d3ce17b7de468c6618e7b2b14"

# Node.js compatibility
compatibility_flags = ["nodejs_compat"]

# ===============================================
# DEV ENVIRONMENT (default/preview)
# ===============================================
[env.dev]
name = "perfex-api-dev"
vars = { ENVIRONMENT = "development", LOG_LEVEL = "debug" }

[[env.dev.d1_databases]]
binding = "DB"
database_name = "perfex-db-dev"
database_id = "990c74a6-b0b6-4904-8d52-5f1968e06768"
migrations_dir = "../../../packages/database/migrations"

[[env.dev.kv_namespaces]]
binding = "SESSIONS"
preview_id = "2cf6285c5c1f4db2a32eb4c71e53cbff"

[[env.dev.kv_namespaces]]
binding = "CACHE"
preview_id = "0392b051b75b4a4ca3136707a71b21a4"

[env.dev.ai]
binding = "AI"

# Cron Triggers for dev
[env.dev.triggers]
crons = [
  "0 * * * *",     # Every hour - Session cleanup
  "0 6 * * *",     # Daily at 6 AM - Risk assessments
  "0 0 * * *",     # Daily at midnight - Overdue task check
  "0 7 * * 1",     # Weekly Monday 7 AM - Reports
  "0 1 * * *",     # Daily at 1 AM - Process scheduled audits
]

# ===============================================
# STAGING ENVIRONMENT
# ===============================================
[env.staging]
name = "perfex-api-staging"
vars = { ENVIRONMENT = "staging", LOG_LEVEL = "info" }

[[env.staging.d1_databases]]
binding = "DB"
database_name = "perfex-db-staging"
database_id = "23e79bcb-34c8-467c-a582-4f363fa1779c"
migrations_dir = "../../../packages/database/migrations"

[[env.staging.kv_namespaces]]
binding = "SESSIONS"
id = "7a0c3cb3fbf047ca9d7f8977c9b98004"

[[env.staging.kv_namespaces]]
binding = "CACHE"
id = "db57371d4269410bb4459e519f5c33c3"

[env.staging.ai]
binding = "AI"

# Cron Triggers for staging
[env.staging.triggers]
crons = [
  "0 * * * *",     # Every hour - Session cleanup
  "0 6 * * *",     # Daily at 6 AM - Risk assessments
  "0 0 * * *",     # Daily at midnight - Overdue task check
  "0 7 * * 1",     # Weekly Monday 7 AM - Reports
  "0 1 * * *",     # Daily at 1 AM - Process scheduled audits
]

# ===============================================
# PRODUCTION ENVIRONMENT
# ===============================================
[env.production]
name = "perfex-api"
vars = { ENVIRONMENT = "production", LOG_LEVEL = "warn" }

[[env.production.d1_databases]]
binding = "DB"
database_name = "perfex-db-prod"
database_id = "709639fa-b262-4d3d-aa8d-8e5120c59681"
migrations_dir = "../../../packages/database/migrations"

[[env.production.kv_namespaces]]
binding = "SESSIONS"
id = "597b6e9781e1490eb2128c51b237d434"

[[env.production.kv_namespaces]]
binding = "CACHE"
id = "7a8a7cc6db774253aa10ff3faba949b6"

[env.production.ai]
binding = "AI"

# Cron Triggers for production
[env.production.triggers]
crons = [
  "0 * * * *",     # Every hour - Session cleanup
  "0 6 * * *",     # Daily at 6 AM - Risk assessments
  "0 0 * * *",     # Daily at midnight - Overdue task check
  "0 7 * * 1",     # Weekly Monday 7 AM - Reports
  "0 1 * * *",     # Daily at 1 AM - Process scheduled audits
]
